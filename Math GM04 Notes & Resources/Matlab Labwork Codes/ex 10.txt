function coeffs = phi_matrix(elem_matrix,list_nodes, K)
% PHI_MATRIX RETURNS A MATRIX OF COEFFICIENTS FOR PIECEWISE LINEAR FUNCTIONS PHI ON A TRIANGULAR DOMAIN TO
% BE USED IN FINITE ELEMENT CALCULATIONS.

% THE INPUT LIST_NODES SHOULD BE AN (NX2) MATRIX, WHERE N IS THE NUMBER OF
% NODES. THE I-TH ROW WILL THEN BE THE (X,Y) CO-ORDINATES OF THE I-TH NODE

% THE INPUT ELEM_MATRIX SHOULD BE AN (MX6) MATRIX WHERE M IS THE NUMBER OF
% ELEMENTS. THE J-TH ROW WILL THEN CONTAIN THE CO-ORDINATES OF THE 3 POINTS
% ASSOCIATED WITH THAT ELEMENT

% THE OUTPUT MATRIX PHI_MATRIX WILL BE (N X 3M). THE I-TH ROW CORRESPONDS
% TO THE FUNCTION THAT IS 1 AT THE NODE LISTED IN THE I-TH ROW OF
% LIST_NODES. THE ENTRIES OF THE ROW ARE THE COEFFICIENTS FOR THE
% DEFINITION OF PHI ON EACH ELEMENT, WITH ORDERING CORRESPONDING TO THE
% ORDER OF ELEMENTS IN ELEM_MATRIX.

% THE CONNECTIVITY MATRIX K TELLS US WHETHER A CERTAIN NODE IS ASSOCIATED
% WITH A CERTAIN ELEMENT. K IS AN (NXM) MATRIX WITH ENTRY (I,J) THAT IS 1
% IF NODE I IS PART OF ELEMENT J, AND 0 OTHERWISE.

N = size(list_nodes,1); % N IS THE NUMBER OF NODES
M = size(elem_matrix,1); % M IS THE NUMBER OF ELEMENTS

coeffs = zeros(N, 3*M);

% OUTER LOOP (I) GOES THROUGH EACH NODE IN TURN TO DEFINE THE FUNCTION ASSOCIATED WITH THAT NODE
% INNER LOOP (J) GOES THROUGH EACH ELEMENT TO CALCULATE THE COEFFICIENTS OF
% PHI ON THAT ELEMENT

for i = 1:N
    for j = 1:M
        if K(i,j) == 1
            % NODE I IS PART OF ELEMENT J SO WE COMPUTE COEFFICIENTS
            pointsx = elem_matrix(j,[1 3 5]);
            pointsy = elem_matrix(j,[2 4 6]); % EXTRACT THE CO-ORDINATES OF POINTS FROM THE ELEMENT MATRIX
            boo = [pointsx.' pointsy.' ones(3,1)]; % MATRIX FOR THE SYSTEM THAT GIVES COEFFICIENTS
            
            whichnode = find(pointsx==list_nodes(i,1) & pointsy == list_nodes(i,2)); % WORKS OUT WHICH NODE AMONGST THE 3 IS ASSOCIATED WITH PHI
            bar = zeros(3,1); 
            bar(whichnode) = 1; % RHS FOR SYSTEM THAT GIVES COEFFICIENTS
            
            foo = boo\bar;
            coeffs(i,3*j-2:3*j) = foo;
        else
            % NODE IS NOT ON THIS ELEMENT, SO COEFFICIENTS ARE 0
            coeffs(i,3*j-2:3*j) = [0 0 0];
        end
    end
end

end